name: ğŸ” PR Preview Build

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  preview-build:
    name: ğŸ¨ Generate PR Preview
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v5
      
    - name: âš¡ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Install VSCE
      run: npm install -g vsce
      
    - name: ğŸ¯ Get PR info
      id: pr_info
      run: |
        echo "pr_number=${{ github.event.number }}" >> $GITHUB_OUTPUT
        echo "pr_sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
        
    - name: ğŸ—ï¸ Build preview extension
      run: |
        # Create preview version with PR info
        PREVIEW_VERSION="$(node -p "require('./package.json').version")-pr${{ steps.pr_info.outputs.pr_number }}-${{ steps.pr_info.outputs.pr_sha }}"
        echo "Building preview version: $PREVIEW_VERSION"
        
        # Temporarily update package.json for preview build
        node -e "
          const pkg = require('./package.json');
          pkg.version = '$PREVIEW_VERSION';
          pkg.displayName = 'ğŸ¦‡ Batman TAS Theme (PR Preview)';
          pkg.description = pkg.description + ' - PR #${{ steps.pr_info.outputs.pr_number }} Preview Build';
          require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));
        "
        
        vsce package --no-git-tag-version
        
    - name: ğŸ“Š Generate theme statistics
      run: |
        echo "## ğŸ¦‡ Batman TAS Theme Preview Build" > preview-info.md
        echo "" >> preview-info.md
        echo "**PR #${{ steps.pr_info.outputs.pr_number }}** - Preview build for commit ${{ steps.pr_info.outputs.pr_sha }}" >> preview-info.md
        echo "" >> preview-info.md
        echo "### ğŸ“Š Theme Statistics" >> preview-info.md
        echo "" >> preview-info.md
        
        # Count colors in theme
        TOTAL_COLORS=$(grep -o '"#[0-9A-Fa-f]\{6\}[0-9A-Fa-f]*"' themes/batman-tas-color-theme.json | wc -l)
        GOTHAM_MIDNIGHT=$(grep -o '#1a1a2e' themes/batman-tas-color-theme.json | wc -l)
        JOKER_PURPLE=$(grep -o '#805ad5' themes/batman-tas-color-theme.json | wc -l)
        TAS_DANGER_RED=$(grep -o '#e53e3e' themes/batman-tas-color-theme.json | wc -l)
        ROBIN_GREEN=$(grep -o '#38a169' themes/batman-tas-color-theme.json | wc -l)
        BATMAN_GRAY=$(grep -o '#4a5568' themes/batman-tas-color-theme.json | wc -l)
        
        echo "- ğŸ¨ **Total Colors**: $TOTAL_COLORS" >> preview-info.md
        echo "- ğŸŒƒ **Gotham Midnight**: $GOTHAM_MIDNIGHT occurrences" >> preview-info.md
        echo "- ğŸŸ£ **Joker Purple**: $JOKER_PURPLE occurrences" >> preview-info.md
        echo "- ğŸ”´ **TAS Danger Red**: $TAS_DANGER_RED occurrences" >> preview-info.md
        echo "- ğŸŸ¢ **Robin Green**: $ROBIN_GREEN occurrences" >> preview-info.md
        echo "- â¬œ **Batman Gray**: $BATMAN_GRAY occurrences" >> preview-info.md
        echo "" >> preview-info.md
        echo "### ğŸ“¦ Installation" >> preview-info.md
        echo "" >> preview-info.md
        echo "Download the preview `.vsix` file from the artifacts and install it in VS Code:" >> preview-info.md
        echo '```bash' >> preview-info.md
        echo 'code --install-extension batman-tas-theme-*-pr${{ steps.pr_info.outputs.pr_number }}-*.vsix' >> preview-info.md
        echo '```' >> preview-info.md
        
    - name: ğŸ’¾ Upload preview artifacts
      uses: actions/upload-artifact@v4
      with:
        name: batman-tas-theme-preview-pr${{ steps.pr_info.outputs.pr_number }}
        path: |
          *.vsix
          preview-info.md
        retention-days: 7
        
    - name: ğŸ“ Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const previewInfo = fs.readFileSync('preview-info.md', 'utf8');
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: previewInfo + '\n\nğŸ”— Download preview from [Actions artifacts](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + ')'
          });